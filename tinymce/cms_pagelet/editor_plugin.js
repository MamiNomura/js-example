var CmsPageletPlugin={getInfo:function(){return{longname:'CMS Pagelet plugin',author:'Michael Pih (mpih@convio.com)',authorurl:'http://www.convio.com',infourl:'http://twiki.convio.com/twiki/bin/view/Engineering/CmsMcePlugins',version:"1.0"};},createControl:function(n,cm){return null;},init:function(ed,url){var th=this;this._url=url;this._pageletSrcArray=[];this._pageletTypeArray=[];this._doVisualAid=true;this._keyToCancel=null;ed.addCommand('pageletShowInsertDialog',function(){th.showInsertDialog(ed);});ed.addCommand('pageletShowAdminDialog',function(node){th.showAdminDialog(ed,node);});ed.addCommand('pageletPreview',function(node){th.preview(ed,node);});ed.addCommand('pageletInsert',function(node,type){th.insert(ed,node,type);});ed.addCommand('pageletInitContextMenu',function(node,menu){th.initContextMenu(node,menu);});ed.addButton('cms_pagelet',{title:'pagelet.desc',cmd:'pageletShowInsertDialog',image:url+'/pagelet.gif'});ed.onInit.add(this.handleEditorInit,this);ed.onVisualAid.add(this.handleVisualAid,this);ed.onBeforeSetContent.add(this.handleBeforeSetContent,this);ed.onSetContent.add(this.handleAfterSetContent,this);ed.onBeforeGetContent.add(this.handleBeforeGetContent,this);ed.onGetContent.add(this.handleAfterGetContent,this);ed.onKeyDown.add(this.handleKeyDown,this);ed.onKeyPress.add(this.handleKeyPress,this);ed.onPaste.add(function(ed,ev){window.setTimeout(function(){if(MceUtils.containsPageletNode(ed.getBody())){th._collapsePreviewContent(ed);th._expandPreviewContent(ed);}},10);});ed.onClick.add(this.handleOnClick,this);},showInsertDialog:function(editor){var folderID=editor.getParam('cmsFolderID');var itemID=editor.getParam('cmsItemID');var templateID=editor.getParam('cmsTemplateID');var isRTF=editor.getParam('isRTF');var dialogPath=this._url+'/pagelet-new.jsp?folderID='+folderID;if(itemID){dialogPath+="&itemID="+itemID;}if(templateID){dialogPath+="&templateID="+templateID;}if(isRTF){dialogPath+="&isRTF="+isRTF;}var bm=editor.selection.getBookmark();var callback={authenticate:true,process:function(o){if(MceUtils.isIE8()){YAHOO.convio.dialog._hide();}editor.selection.moveToBookmark(bm);var response=null;try{response=YAHOO.lang.JSON.parse(o.responseText);}catch(e){alert("Failed to create component.");return;}if(!response.type){alert("Failed to create component: missing component type.");return;}if(response.error){var msg="Failed to insert "+response.type.label+" component.";YAHOO.convio.dialog.showError({msg:msg,detail:response.error});return;}var pageletTag=response.type.key+"-"+response.id;var content=response.content;var ed=tinyMCE.activeEditor;var selection=ed.selection;var pageletEl=ed.dom.create('div',{id:pageletTag},content);pageletEl.className='templateComponent';var styleFloat=response.float;if(styleFloat==null||styleFloat=="none"){ed.dom.setStyle(pageletEl,"float","");}else{ed.dom.setStyle(pageletEl,"float",styleFloat);}pageletEl.style.display="inline";pageletEl.style.width="auto";MceUtils.setStyleProperty(pageletEl,"marginRight",response.marginRight);MceUtils.setStyleProperty(pageletEl,"marginLeft",response.marginLeft);MceUtils.setStyleProperty(pageletEl,"marginTop",response.marginTop);MceUtils.setStyleProperty(pageletEl,"marginBottom",response.marginBottom);MceUtils.setStyleProperty(pageletEl,"width",response.width,response.widthUnits);var pageletType={name:response.type.key,label:response.type.label,adminDialog:response.type.adminPath,adminDialogType:response.type.adminDialogType};ed.execCommand('pageletInsert',pageletEl,pageletType,pageletEl,{skip_undo:true});}};YAHOO.convio.dialog.open(dialogPath,callback);},showAdminDialog:function(editor,node){if(!node){node=editor.selection.getNode();}var pageletNode=MceUtils.findPageletNode(editor,node);if(pageletNode==null){return;}var pageletTag=pageletNode.id;if(!pageletTag){return;}var pageletData=MceUtils.parsePageletTag(pageletTag);var pageletID=pageletData.id;var pageletTypeKey=pageletData.key;var pageletType=this._pageletTypeArray[pageletTypeKey];var adminDialog=(pageletType!=null?pageletType.adminDialog:null);var adminDialogType=(pageletType!=null?pageletType.adminDialogType:null);var configScript=(pageletType!=null?pageletType.configScript:null);if(adminDialog==null&&configScript==null){return;}if(configScript!=null){var pageletArg={id:pageletID,node:pageletNode};var configFn=new Function("pagelet",configScript);configFn.call(this,pageletArg);}else{var folderID=editor.getParam('cmsFolderID');var typeID=editor.getParam('cmsTypeID');if(pageletID==null){adminDialog="/admin/pagelet/default.jsp?folderID="+folderID;adminDialog+="&pageletType="+escape(pageletTypeKey);}else{if(!adminDialog.match(/^(\/|https?:)/)){adminDialog=this._url+adminDialog;}adminDialog+=adminDialog.match(/\?/)?"&":"?";adminDialog+="folderID="+folderID+"&pageletID="+pageletID;if(typeID!=null){adminDialog+="&typeID="+typeID;}}var pageletWidth=440;if(pageletTypeKey=="include"){pageletWidth=840;}if(adminDialogType=="yui"){YAHOO.convio.dialog.open(adminDialog,{process:function(){editor.execCommand('cmsSetModified',false,{skip_undo:true});editor.execCommand('pageletPreview',pageletNode,pageletNode,{skip_undo:true});},authenticate:true,argument:{}});}else if(adminDialogType=="window"){YAHOO.convio.dialog.popup({url:adminDialog,width:pageletWidth,height:480,authenticate:true,inline:true},{},function(returnValue){if(returnValue){editor.execCommand('cmsSetModified',false,{skip_undo:true});editor.execCommand('pageletPreview',pageletNode,pageletNode,{skip_undo:true});}});}else{alert("Unrecognized admin dialog type: "+adminDialogType);return;}}},showLayoutDialog:function(n){var editor=tinyMCE.activeEditor;if(!n||!MceUtils.isPageletNode(n)){return;}var pageletTag=n.id;if(!pageletTag){return;}var pageletData=MceUtils.parsePageletTag(pageletTag);var pageletID=pageletData.id;var dialogPath=null;if(pageletID!=null){dialogPath=this._url+"/pagelet-layout.jsp?pageletID="+pageletID;}else{dialogPath=this._url+"/pagelet-layout.jsp?pageletTag="+pageletTag;}var callback={authenticate:true,init:function(o){var _loadStyleProperty=function(property,units){var re=/(\d+)(%|px)?/;var arr=re.exec(n.style[property]);if(arr){setValue("pageletLayoutForm",property,RegExp.$1);if(units){setValue("pageletLayoutForm",units,RegExp.$2);}}};var styleFloat=editor.dom.getStyle(n,'float');if(styleFloat){setValue("pageletLayoutForm","float",styleFloat);}_loadStyleProperty("marginRight");_loadStyleProperty("marginLeft");_loadStyleProperty("marginTop");_loadStyleProperty("marginBottom");_loadStyleProperty("width","widthUnits");},process:function(o){var _applyStyleProperty=function(property,units){var value=getValue("pageletLayoutForm",property);if(isNaN(value)||value<1){editor.dom.setStyle(n,property,"");return;}if(units){value+=getValue("pageletLayoutForm",units);}editor.dom.setStyle(n,property,value);};var float=getValue("pageletLayoutForm","float");if(float=="none"){editor.dom.setStyle(n,"float",'');}else{editor.dom.setStyle(n,"float",float);}_applyStyleProperty("marginRight");_applyStyleProperty("marginLeft");_applyStyleProperty("marginTop");_applyStyleProperty("marginBottom");_applyStyleProperty("width","widthUnits");editor.undoManager.add();editor.execCommand('pageletPreview',n,n,{skip_undo:true});}};YAHOO.convio.dialog.open(dialogPath,callback);},preview:function(editor,node){var pageletNode=MceUtils.findPageletNode(editor,node);if(pageletNode==null){return;}this._pageletSrcArray[pageletNode.id]=null;this._expandPreviewContent(editor);},insert:function(editor,node,type){if(!MceUtils.isPageletNode(node)){return;}editor.execCommand('noneditableSetNoneditable',false,node,{skip_undo:true});MceUtils.insertAtSelection(editor,node);var configScript=null;var editorConfigDiv=editor.dom.get("editorConfig");if(editorConfigDiv&&YAHOO.util.Dom.hasClass(editorConfigDiv,"editorConfig-"+type.name)){configScript=tinymce.trim(editorConfigDiv.firstChild.nodeValue);CmsXBrowser.removeNode(editorConfigDiv,true);}if(configScript){type.configScript=configScript;}this._cleanupPreviewContent(node);this._registerPageletType(type);editor.execCommand('pageletPreview',node,node,{skip_undo:true});if(type.adminDialog!=null||type.configScript!=null){editor.execCommand('pageletShowAdminDialog',node,node,{skip_undo:true});}},initContextMenu:function(node,menu){if(!MceUtils.isPageletNode(node)){return;}var th=this;var ed=tinyMCE.activeEditor;var pageletData=MceUtils.parsePageletTag(node.id);var pageletTypeKey=pageletData.key;var pageletType=this._pageletTypeArray[pageletTypeKey];var typeLabel=pageletType.label;if(!typeLabel){typeLabel='Component';}MceUtils.selectNonEditable(ed,node);if(pageletTypeKey!='image'){menu.addSeparator();menu.add({title:'Component Style and Layout...',onclick:function(){th.showLayoutDialog(node);}});if(pageletType.adminDialog!=null||pageletType.configScript!=null){menu.add({title:'Manage '+typeLabel+'...',ui:true,onclick:function(){ed.execCommand('pageletShowAdminDialog',node,node,{skip_undo:true});}});}}},handleEditorInit:function(editor){if(YAHOO.env.ua.ie>0&&YAHOO.env.ua.ie<9){editor.dom.loadCSS(this._url+'/pagelet.css');}else{editor.dom.loadCSS(this._url+'/pagelet-gecko.css');}},handleOnClick:function(editor,event){var pageletNode=MceUtils.findPageletNode(editor,event.target);if(pageletNode!=null){if(event.button==0){tinymce.dom.Event.prevent(event);}MceUtils.selectNonEditable(editor,pageletNode);}return true;},handleKeyDown:function(editor,event){if((tinymce.isMac?event.metaKey:event.ctrlKey)){switch(event.keyCode){case 67:if(MceUtils.copyNonEditable(editor,'templateComponent')){tinymce.dom.Event.cancel(event);this._keyToCancel=event.keyCode;}break;case 88:if(MceUtils.cutNonEditable(editor,'templateComponent')){tinymce.dom.Event.cancel(event);this._keyToCancel=event.keyCode;}break;default:return;}}else{switch(event.keyCode){case 8:case 46:if(MceUtils.cutNonEditable(editor,'templateComponent')){tinymce.dom.Event.cancel(event);this._keyToCancel=event.keyCode;return false;}break;default:return;}}},handleKeyPress:function(editor,event){var key=event.keyCode;var rc=(this._keyToCancel==key)?tinymce.dom.Event.cancel(event):true;this._keyToCancel=null;return rc;},handleVisualAid:function(editor,node,state){this._doVisualAid=(state?true:false);this._setVisualAid(editor,node);},_setVisualAid:function(editor,node){var dom=editor.dom;var th=this;var toggleVA=function(n){if(th._doVisualAid){dom.addClass(n,'mceCmsPageletVA');}else{dom.removeClass(n,'mceCmsPageletVA');}};MceUtils.visitPageletNodes(node,this,toggleVA);},handleBeforeGetContent:function(editor,context){if(context.format=='html'){this._collapsePreviewContent(editor);}},handleAfterGetContent:function(editor,context){if(context.format=='html'){this._expandPreviewContent(editor);}},handleBeforeSetContent:function(editor,context){},handleAfterSetContent:function(editor,context){this._expandPreviewContent(editor);},_findSelectedPageletNode:function(editor){var pageletNode=MceUtils.findPageletNode(editor,editor.selection.getNode());if(tinymce.isIE){if(pageletNode!=null&&pageletNode==MceUtils.findPageletNode(editor,editor.selection.getStart())&&pageletNode==MceUtils.findPageletNode(editor,editor.selection.getEnd())){return pageletNode;}return null;}else{return pageletNode;}},_registerPageletType:function(type){if(this._pageletTypeArray[type.name]==null){this._pageletTypeArray[type.name]={label:type.label,adminDialog:type.adminDialog,adminDialogType:type.adminDialogType,configScript:type.configScript};}},_expandPreviewContent:function(editor){var node=editor.getBody();var expandFn=function(n){n=this._replaceIncludeTag(editor,n);MceUtils.splitInlineParents(editor,n);this._setVisualAid(editor,n);var innerhtml=null;try{if(this._pageletSrcArray[n.id]!=null){innerhtml=this._pageletSrcArray[n.id].innerHTML;}}catch(ex){}if(innerhtml!=null){editor.dom.setHTML(n,innerhtml);editor.execCommand('noneditableSetNoneditable',false,n,{skip_undo:true});}else{if(!n.innerHTML){editor.dom.setHTML(n,'loading...');}var previewUrl=this._url+'/pagelet-preview.jsp';previewUrl+='?folderID='+editor.getParam("cmsFolderID");var itemID=editor.getParam("cmsItemID");if(itemID){previewUrl+='&itemID='+itemID;}previewUrl+='&pageletTag='+n.id;var srcArray=this._pageletSrcArray;var th=this;var callback={success:function(o){var response=null;try{response=YAHOO.lang.JSON.parse(o.responseText);}catch(e){alert("Failed to load component."+e);return;}if(!response.type){alert("Failed to load component: missing component type.");return;}if(response.error){var msg="Failed to load "+response.type.label+" component.";YAHOO.convio.dialog.showError({msg:msg,detail:response.error});editor.dom.setHTML(n,msg);editor.execCommand('noneditableSetNoneditable',false,n,{skip_undo:true});th._setVisualAid(editor,n);var pageletType={name:response.type.key,label:response.type.label,adminDialog:response.type.adminPath,adminDialogType:response.type.adminDialogType,configScript:null};th._registerPageletType(pageletType);return;}var content=response.content;editor.dom.setHTML(n,content);var configScript=null;var editorConfigDiv=editor.dom.get("editorConfig");if(editorConfigDiv&&YAHOO.util.Dom.hasClass(editorConfigDiv,"editorConfig-"+response.type.key)){configScript=tinymce.trim(editorConfigDiv.firstChild.nodeValue);CmsXBrowser.removeNode(editorConfigDiv,true);}th._cleanupPreviewContent(n);editor.execCommand('noneditableSetNoneditable',false,n,{skip_undo:true});th._setVisualAid(editor,n);var newNode=CmsXBrowser.cloneNode(n);srcArray[newNode.id]=newNode;var pageletType={name:response.type.key,label:response.type.label,adminDialog:response.type.adminPath,adminDialogType:response.type.adminDialogType,configScript:configScript};th._registerPageletType(pageletType);},failure:function(o){YAHOO.convio.dialog.showError({msg:"Failed to load component",detail:o.responseText});},timeout:10000,cache:false,argument:[]};YAHOO.util.Connect.asyncRequest('GET',previewUrl,callback);}};MceUtils.visitPageletNodes(node,this,expandFn);},_collapsePreviewContent:function(editor){var node=editor.getBody();var collapseFn=function(n){var newNode=CmsXBrowser.cloneNode(n);this._pageletSrcArray[newNode.id]=newNode;editor.dom.setHTML(n,'');editor.dom.removeClass(n,'mceCmsPageletVA');editor.dom.removeClass(n,'mceNonEditable');};MceUtils.visitPageletNodes(node,this,collapseFn);},_cleanupPreviewContent:function(node){var removeFn=function(n){if(n){if(n.style&&n.style.display=="none"){CmsXBrowser.removeNode(n,true);}if(n.onclick){n.onclick=null;}}};tinymce.walk(node,removeFn,'childNodes',this);if(this._isEmpty(node)){node.innerHTML='&nbsp;'+node.innerHTML;}},_isEmpty:function(node){if(!node){alert("node is required");}if(!node.innerHTML||/^\s*$/.test(node.innerHTML)){return true;}if(node.childNodes){var nonContent=true;for(var i=0;i<node.childNodes.length;i++){var child=node.childNodes[i];var nodeType=child.nodeType;var nodeName=child.nodeName.toUpperCase();if(nodeType==1){if(nodeName!='STYLE'&&nodeName!='MCE:STYLE'){nonContent=false;break;}}else if(nodeType==3){var isWhiteSpace=(''==tinymce.trim(child.nodeValue));if(!isWhiteSpace){nonContent=false;break;}}else if(nodeType==8){}else{nonContent=false;break;}}if(nonContent){return true;}}return false;},_replaceIncludeTag:function(editor,node){if(node.nodeName.toLowerCase()=='include'&&node.id){var pageletEl=editor.dom.create('div',{id:node.id},null);pageletEl.className='templateComponent';editor.dom.replace(pageletEl,node,true);return pageletEl;}return node;}};tinymce.PluginManager.requireLangPack('cms_pagelet');tinymce.create('tinymce.plugins.PageletPlugin',CmsPageletPlugin);tinymce.PluginManager.add('cms_pagelet',tinymce.plugins.PageletPlugin);